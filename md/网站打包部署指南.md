# 咖啡名片编辑器 - 网站打包部署指南

## 🚀 快速打包

### 方法一：一键打包（推荐）
```bash
# Windows
打包.bat

# Linux/Mac
chmod +x 打包.sh
./打包.sh
```

### 方法二：手动打包
```bash
# 1. 安装依赖
npm install

# 2. 运行打包脚本
node package-simple.js
```

## 📦 打包内容

打包后的 `coffee-editor/` 文件夹包含：

```
coffee-editor/
├── index.html              # 主页面
├── style.css               # 样式文件
├── script.js               # 前端逻辑
├── server.js               # 后端服务器
├── package.json            # 项目配置
├── package-lock.json       # 依赖锁定
├── config.js               # CDN配置文件
└── 宝塔部署说明.txt        # 部署指南
```

## 🌐 部署方式

### 1. 宝塔面板部署（推荐）

#### 步骤：
1. **上传文件**
   - 登录宝塔面板
   - 进入"文件"管理
   - 上传 `coffee-editor` 文件夹到网站目录
   - 解压到网站根目录

2. **安装Node.js**
   - 宝塔面板 → 软件商店
   - 搜索"Node.js版本管理器"
   - 安装 Node.js 16.x 或更高版本

3. **安装依赖**
   - 宝塔面板 → 终端
   - 进入网站目录：`cd /www/wwwroot/您的域名/`
   - 运行：`npm install`

4. **启动服务**
   - 宝塔面板 → PM2管理器
   - 添加项目：
     - 名称：`coffee-editor`
     - 启动文件：`server.js`
     - 端口：`3000`
   - 点击启动

5. **访问网站**
   - 地址：`http://您的域名:3000`
   - 或配置反向代理到80端口

#### 常用PM2命令：
```bash
# 重启服务
pm2 restart coffee-editor

# 查看日志
pm2 logs coffee-editor

# 停止服务
pm2 stop coffee-editor

# 查看状态
pm2 status
```

### 2. 云服务器部署

#### 环境要求：
- Node.js 16.x 或更高版本
- 至少 512MB 内存
- 支持端口 3000

#### 部署步骤：
```bash
# 1. 上传文件到服务器
scp -r coffee-editor/ user@your-server:/var/www/

# 2. 登录服务器
ssh user@your-server

# 3. 进入项目目录
cd /var/www/coffee-editor

# 4. 安装依赖
npm install --production

# 5. 启动服务
npm start

# 6. 使用PM2管理（推荐）
npm install -g pm2
pm2 start server.js --name coffee-editor
pm2 startup
pm2 save
```

### 3. Docker部署

#### 创建 Dockerfile：
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

#### 构建和运行：
```bash
# 构建镜像
docker build -t coffee-card-editor .

# 运行容器
docker run -d \
  --name coffee-card-editor \
  -p 3000:3000 \
  -v $(pwd)/img:/app/img \
  coffee-card-editor
```

### 4. 静态文件部署

#### 修改为静态网站：
```javascript
// 修改 server.js，添加静态文件服务
app.use(express.static('public'));

// 将前端文件移动到 public 目录
// public/
//   ├── index.html
//   ├── style.css
//   ├── script.js
//   └── config.js
```

#### CDN配置要求：
- 系统完全依赖CDN获取图片
- 需要配置正确的CDN地址在 config.js 中
- 确保CDN服务可用且支持跨域访问

#### 部署到CDN：
```bash
# 阿里云OSS
ossutil cp -r ./public/ oss://your-bucket/coffee-card-editor/

# 腾讯云COS
coscmd upload -r ./public/ /coffee-card-editor/

# AWS S3
aws s3 sync ./public/ s3://your-bucket/coffee-card-editor/
```

## 🔧 配置说明

### 环境变量
```bash
# 创建 .env 文件
NODE_ENV=production
PORT=3000
LOG_DIR=/var/log/coffee-card-editor
```

### 反向代理配置（Nginx）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### SSL证书配置
```bash
# 使用 Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 📊 性能优化

### 1. 启用Gzip压缩
```javascript
const compression = require('compression');
app.use(compression());
```

### 2. 设置缓存头
```javascript
app.use(express.static('public', {
    maxAge: '1d',
    etag: true
}));
```

### 3. 使用CDN
- 系统完全依赖CDN获取图片
- 修改 `config.js` 中的CDN配置
- 确保CDN服务可用且支持跨域访问

## 🛠️ 故障排除

### 常见问题：

1. **端口被占用**
   ```bash
   # 查看端口占用
   netstat -tulpn | grep :3000
   
   # 杀死进程
   kill -9 PID
   ```

2. **CDN配置问题**
   ```bash
   # 检查config.js中的CDN配置
   cat config.js
   
   # 测试CDN连接
   curl -I https://your-cdn-domain.com/images.json
   ```

3. **内存不足**
   ```bash
   # 增加交换空间
   sudo fallocate -l 1G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   ```

4. **PM2启动失败**
   ```bash
   # 查看详细日志
   pm2 logs coffee-editor --lines 100
   
   # 重启PM2
   pm2 kill
   pm2 start server.js --name coffee-editor
   ```

## 📈 监控和维护

### 1. 日志管理
```bash
# 设置日志轮转
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

### 2. 性能监控
```bash
# 查看资源使用
pm2 monit

# 查看进程信息
pm2 show coffee-editor
```

### 3. 自动备份
```bash
# 设置定时备份
crontab -e

# 添加以下行（每天凌晨2点备份）
0 2 * * * tar -czf /backup/coffee-card-editor-$(date +\%Y\%m\%d).tar.gz /var/www/coffee-card-editor
```

## 🎯 最佳实践

1. **使用PM2管理进程**：确保服务稳定运行
2. **配置反向代理**：隐藏端口，使用标准80/443端口
3. **启用SSL证书**：提供HTTPS访问
4. **定期备份**：防止数据丢失
5. **监控日志**：及时发现问题
6. **配置CDN**：确保图片加载速度和可用性
7. **设置防火墙**：只开放必要端口
8. **测试CDN连接**：确保CDN服务稳定可用

## 📞 技术支持

如果遇到问题，请检查：
1. Node.js版本是否兼容
2. 端口3000是否可用
3. CDN配置是否正确
4. 网络连接是否正常
5. 依赖是否完整安装
6. 服务器内存是否充足

---

**祝您部署成功！** 🎉
